C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE API_LCD_DISPLAY
OBJECT MODULE PLACED IN .\Api_Lcd_Display.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\C_Source\S4_ApiUser\Api_Lcd_Display.c LARGE WARNINGLEVEL(1) BROWSE INCDI
                    -R(..\C_Source\S0_System;..\C_Source\S1_HardDrv;..\C_Source\S2_MyLib;..\C_Source\S3_ApiPlat;..\C_Source\S4_ApiUser;..\C_S
                    -ource\S5_ApiProtocol;..\C_Source\S6_MyIncludes;..\C_Source\S1_HardDrv\V9811A_EMU;..\C_Source\S1_HardDrv\V9811A_MCU;..\C_
                    -Source\S1_HardDrv\E2P_24CXXX) DEBUG OBJECTEXTEND PRINT(.\Api_Lcd_Display.lst) OBJECT(.\Api_Lcd_Display.obj)

line level    source

   1          /*
   2          *****************Copyright (c)*************************************
   3          **      Hangzhou Xili Watthour Meter Manufacture Co., Ltd. 
   4          **--------------file info--------------------------------------------
   5          **name                  : Api_Lcd_Display.c
   6          **Author                : maji
   7          **date                  : 2016-04-21 
   8          **description   : Òº¾§ÏÔÊ¾Ó¦ÓÃ²ãÏà¹Øº¯Êý³ÌÐòCÎÄ¼þ
   9          **note                  : V9811A £¬MERTER FOR DL03C
  10          **--------------------Version History -------------------------------------
  11          ** NO. Date         Ver      By         Description 
  12          **==============================================================
  13          ** 1   2016-04-26   v01.00   sosomj     1. frist version                             
  14          **
  15          **==============================================================
  16          */
  17          
  18          
  19          #include <MyIncludes_H.h>
  20          
  21          
  22          /*******************************************************************************
  23          * È«¾Ö±äÁ¿¶¨ÒåÇø
  24          *******************************************************************************/
  25          DIS_PARAM_DATA   gs_dis_param;   // µçÁ¿ÏÔÊ¾Ïà¹Ø²ÎÊý  //
  26          DIS_CTL_VAR  gs_dis_ctl_var;
  27          DIS_PIXEL_VAR  gs_dis_pixel_var;
  28          LCDDISTAB   gs_LCDDISTAB_var;
  29          
  30          /*******************************************************************************
  31          * ³£Á¿±íÇø
  32          *******************************************************************************/
  33          const DIS_PARAM_DATA  code default_dis_param_tab= {
  34              5,  //uint8  auto_sec;    // ×Ô¶¯Ñ­»·ÏÔÊ¾³ÖÐøÊ±¼ä  //
  35              30, //uint8  key_sec;     // °´¼üÏÔÊ¾³ÖÐøÊ±¼ä  //
  36              30,//uint8  bg_sec;     // ±³¹âµãÁÁ³ÖÐøÊ±¼ä  //
  37              0x80,//uint8  ec_form;     // µçÁ¿¸ñÊ½  //
  38              2,//uint8  auto_item[11];    //0ÎªÏÔÊ¾¸öÊý£¬1~10ÎªÏÔÊ¾ÏîÄ¿£¬×î´ó¿ÉÒÔÏÔÊ¾10¸öÏîÄ¿  //
  39              6,1,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,//uint8  auto_item[1~10];     //
  40              7,//uint8  key_item[11];    //0ÎªÏÔÊ¾¸öÊý£¬1~10ÎªÏÔÊ¾ÏîÄ¿£¬×î´ó¿ÉÒÔÏÔÊ¾10¸öÏîÄ¿  //
  41              36,37,32,31,6,1,34,0XFF,0XFF,0XFF,//uint8  key_item[1~10];     //
  42              2,//uint8  pwn_item[11];    //0ÎªÏÔÊ¾¸öÊý£¬1~9ÎªÏÔÊ¾ÏîÄ¿£¬×î´ó¿ÉÒÔÏÔÊ¾9¸öÏîÄ¿  //
  43              6,1,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,//uint8  auto_item[1~9];     //    
  44              0x00,//INT16U  u16_csck;    //16Î»ÀÛ¼ÓºÍÐ£ÑéÖµ//
  45          };
  46          
  47          
  48          
  49          //  ³£Á¿×Ö·û±í¶¨Òå x//
  50          const INT8U  code NumSeg[DS_Chr_All_NUM] = {
  51                  DS_Chr_0, DS_Chr_1, DS_Chr_2, DS_Chr_3,
  52                  DS_Chr_4, DS_Chr_5, DS_Chr_6, DS_Chr_7,
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 2   

  53                  DS_Chr_8, DS_Chr_9, DS_Chr_A, DS_Chr_b, 
  54                  DS_Chr_C, DS_Chr_d, DS_Chr_E, DS_Chr_F,
  55          };
  56          
  57          // obisÏÂÅÅÇ°ÈýÎ»Êý×Ö x//
  58          const INT8U  code NumSegOBIS[DS_Chr_All_NUM] = {
  59                  DS_OBIS_Chr_0, DS_OBIS_Chr_1, DS_OBIS_Chr_2, DS_OBIS_Chr_3,
  60                  DS_OBIS_Chr_4, DS_OBIS_Chr_5, DS_OBIS_Chr_6, DS_OBIS_Chr_7,
  61                  DS_OBIS_Chr_8, DS_OBIS_Chr_9, DS_OBIS_Chr_A, DS_OBIS_Chr_b, 
  62                  DS_OBIS_Chr_C, DS_OBIS_Chr_d, DS_OBIS_Chr_E, DS_OBIS_Chr_F,
  63          };
  64          
  65          
  66          // ÏÂÅÅOBIS ×îºóÒ»Î»Êý¾Ý//
  67          const INT8U  code NumSegOBIS1[DS_Chr_All_NUM] = {
  68                  DS_OBIS1_Chr_0, DS_OBIS1_Chr_1, DS_OBIS1_Chr_2, DS_OBIS1_Chr_3,
  69                  DS_OBIS1_Chr_4, DS_OBIS1_Chr_5, DS_OBIS1_Chr_6, DS_OBIS1_Chr_7,
  70                  DS_OBIS1_Chr_8, DS_OBIS1_Chr_9, DS_OBIS1_Chr_A, DS_OBIS1_Chr_b, 
  71                  DS_OBIS1_Chr_C, DS_OBIS1_Chr_d, DS_OBIS1_Chr_E, DS_OBIS1_Chr_F,
  72          };
  73          
  74          //-------------------------------------------------------------------------------//
  75          //  Function:     Òº¾§ÏÔÊ¾ÏîÄ¿µÄÔªËØ±í       --ÔÚROMÇø
  76          //-------------------------------------------------------------------------------//
  77          const LCDDISTAB code LcdDisTab[] =
  78           {  
  79          //ID    obis            obis    addr                    
  80              ////////////////////////////ALL  DISPLAY////////////////////////////////////////////////////////
  81              0,  0x8888, 0X0000,                                                                         0 ,                                     0,      OBIS_DIGIT_TYPE0,       // ALL DISPLAY  //
  82              ////////////////////////////ACTIVE ENERGY  DISPLAY////////////////////////////////////////////////////
             -////
  83              0x01,  0x180F,       (INT16U)&gs_energy_user_data.us_val[0][0].buf[0],               (MEM_RAM<<8)+6,        CHAR_A
             -EC,OBIS_DIGIT_TYPE1,  // L0 ACTIVE ENERGY TOTAL 
  84              0x02,  0x181F,       (INT16U)&gs_energy_user_data.us_val[0][1].buf[0],               (MEM_RAM<<8)+6,        CHAR_A
             -EC,OBIS_DIGIT_TYPE1,  // L0 ACTIVE ENERGY T1
  85              0x03,  0x182F,       (INT16U)&gs_energy_user_data.us_val[0][2].buf[0],               (MEM_RAM<<8)+6,        CHAR_A
             -EC,OBIS_DIGIT_TYPE1,  // L0 ACTIVE ENERGY T1
  86              0x04,  0x183F,       (INT16U)&gs_energy_user_data.us_val[0][3].buf[0],               (MEM_RAM<<8)+6,        CHAR_A
             -EC,OBIS_DIGIT_TYPE1,  // L0 ACTIVE ENERGY T1
  87              0x05,  0x184F,       (INT16U)&gs_energy_user_data.us_val[0][4].buf[0],               (MEM_RAM<<8)+6,        CHAR_A
             -EC,OBIS_DIGIT_TYPE1,  // L0 ACTIVE ENERGY T1
  88              0X06,  0x1800,       ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_ec,                                                           (MEM_
             -E2P1<<8)+6,CHAR_AEC,OBIS_DIGIT_TYPE2, //L1 ACTIVE ENERGY TOTAL 
  89              0X07,  0x1810,       ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_ec+1*LEN_EC_UNIT ,                               (MEM_E2P1<<
             -8)+6,CHAR_AEC,OBIS_DIGIT_TYPE2,       //L1 ACTIVE ENERGY T1
  90              0X08,  0x1820,       ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_ec+ 2*LEN_EC_UNIT,                                (MEM_E2P1<<8)+6,CH
             -AR_AEC,OBIS_DIGIT_TYPE2,      //L1 ACTIVE ENERGY T2
  91              0X09,  0x1830,       ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_ec+ 3*LEN_EC_UNIT,                                (MEM_E2P1<<8)+6,CH
             -AR_AEC,OBIS_DIGIT_TYPE2,      //L1 ACTIVE ENERGY T3
  92              0X0A,  0x1840,    ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_ec+ 4*LEN_EC_UNIT,                           (MEM_E2P1<<8)+6,C
             -HAR_AEC,OBIS_DIGIT_TYPE2,     //L1 ACTIVE ENERGY T2
  93              0X0B,  0x1801,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_ec ,                                                                
             -  (MEM_E2P1<<8)+6,CHAR_AEC,OBIS_DIGIT_TYPE2,  //L1 ACTIVE ENERGY TOTAL 
  94              0X0C,  0x1811,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_ec+1*LEN_EC_UNIT,                                (MEM_E2
             -P1<<8)+6,CHAR_AEC,OBIS_DIGIT_TYPE2,   //L1 ACTIVE ENERGY T1
  95              0X0D,  0x1821,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_ec+2*LEN_EC_UNIT,                                 (MEM_E2P1<<8)
             -+6,CHAR_AEC,OBIS_DIGIT_TYPE2, //L1 ACTIVE ENERGY T2
  96              0X0E,  0x1831,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_ec+3*LEN_EC_UNIT,                                 (MEM_E2P1<<8)
             -+6,CHAR_AEC,OBIS_DIGIT_TYPE2, //L1 ACTIVE ENERGY T3
  97              0X0F,  0x1841,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_ec+4*LEN_EC_UNIT,                                 (MEM_E2P1<<8)
             -+6,CHAR_AEC,OBIS_DIGIT_TYPE2, //L1 ACTIVE ENERGY T2
  98              0X10,  0x160F,      ADR_BLOCK01_MMD_L0_E2P + 0*LEN_MMD_UNIT,                                (MEM_E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_TYPE1,       
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 3   

             -//L0 ACTIVE MAX DEMAND TOTAL  XX.XXXXKW
  99              0X11,  0x161F,      ADR_BLOCK01_MMD_L0_E2P + 1*LEN_MMD_UNIT,                                (MEM_E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_TYPE1,       
             -//L0 ACTIVE MAX DEMAND T1  XX.XXXXKW
 100              0X12,  0x162F,      ADR_BLOCK01_MMD_L0_E2P + 2*LEN_MMD_UNIT,                                (MEM_E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_TYPE1,       
             -//L0 ACTIVE MAX DEMAND T2  XX.XXXXKW
 101              0X13,  0x163F,      ADR_BLOCK01_MMD_L0_E2P + 3*LEN_MMD_UNIT,                                (MEM_E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_TYPE1,       
             -//L0 ACTIVE MAX DEMAND T3  XX.XXXXKW
 102              0X14,  0x164F,      ADR_BLOCK01_MMD_L0_E2P + 4*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_T
             -YPE1,        //L0 ACTIVE MAX DEMAND T4  XX.XXXXKW     
 103              0X15,  0x1600,      ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_mmd+ 0*LEN_MMD_UNIT,                              (MEM_E2P1<<
             -8)+3,CHAR_MD,OBIS_DIGIT_TYPE2,        //L0 ACTIVE MAX DEMAND TOTAL  XX.XXXXKW
 104              0X16,  0x1610,      ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_mmd+ 1*LEN_MMD_UNIT,                              (MEM_E2P1<<
             -8)+3,CHAR_MD,OBIS_DIGIT_TYPE2,        //L0 ACTIVE MAX DEMAND T1  XX.XXXXKW
 105              0X17,  0x1620,      ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_mmd+ 2*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T2  XX.XXXXKW
 106              0X18,  0x1630,      ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_mmd+ 3*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T3  XX.XXXXKW
 107              0X19,  0x1640,      ADR_BLOCK101_BILL1_DATA_E2P+OFFSET_bill_data_mmd+ 4*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T4  XX.XXXXKW    
 108              0X1a,  0x1601,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_mmd+ 0*LEN_MMD_UNIT,                             (MEM_
             -E2P1<<8)+3,CHAR_MD,OBIS_DIGIT_TYPE2,  //L0 ACTIVE MAX DEMAND TOTAL  XX.XXXXKW
 109              0X1b,  0x1611,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_mmd+ 1*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T1  XX.XXXXKW
 110              0X1c,  0x1621,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_mmd+ 2*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T2  XX.XXXXKW
 111              0X1d,  0x1631,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_mmd+ 3*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T3  XX.XXXXKW
 112              0X1e,  0x1641,      ADR_BLOCK102_BILL2_DATA_E2P+OFFSET_bill_data_mmd+ 4*LEN_MMD_UNIT,                               (MEM_E2P1<<8)+3,C
             -HAR_MD,OBIS_DIGIT_TYPE2,      //L0 ACTIVE MAX DEMAND T4  XX.XXXXKW    
 113          
 114              0X1F,  0x3270,      (INT16U)&gs_measure_var_data.gs_really[0].dw_u_val.B08[2],(MEM_RAM<<8)+2,       CHAR_V,OBIS_D
             -IGIT_TYPE3,                        // L1 µçÑ¹ (3+1)  AÏà
 115              0x20,  0x3170,      (INT16U)&gs_measure_var_data.gs_really[0].dw_i_val.B08[0],(MEM_RAM<<8)+3,       CHAR_A,OBIS_D
             -IGIT_TYPE3,                        // L1 µçÑ¹ (3+1)  AÏà
 116              0x21,  0x170F,      (INT16U)&gs_measure_var_data.gs_really[0].dw_p_val.B08[0],(MEM_RAM<<8)+3,       CHAR_KW,OBIS_
             -DIGIT_TYPE1,        // total ac power       
 117              0x22,  0x1370,      (INT16U)&gs_measure_var_data.gs_really[0].dw_pf_val.B08[0],(MEM_RAM<<8)+2,      CHAR_PF,OBIS
             -_DIGIT_TYPE3,        // total PF     
 118              0x23,  0x1470,      (INT16U)&gs_measure_var_data.gs_really[0].w_freq_val.B08[0],(MEM_RAM<<8)+2,     CHAR_HZ,OBI
             -S_DIGIT_TYPE3,        // FREQUENCE
 119              0x24,  0x092F,      (INT16U)&gs_CurDateTime.Year,                   (MEM_RAM<<8)+3,                         CHAR_DATE,OBIS_DIGIT_TYPE1,     //ÈÕÆÚ 
             -ÄêÔÂÈÕ
 120              0x25,  0x091F,      (INT16U)&gs_CurDateTime.Hour,                           (MEM_RAM<<8)+3,                         CHAR_TIME,OBIS_DIGIT_TYPE1,     //Ê±¼ä 
             -(Ê±-·Ö-Ãë)
 121              0x26,  0xC10F,      ADR_METER_PARAM1_METER_ID,               (MEM_E2P1<<8)+8,               0,OBIS_DIGIT_TYPE1,     //meter 
             -id    LOW 8byte  //
 122              0x27,  0x030F,      &sys_parm.meter_cons[0],                              (MEM_RAM<<8)+3,           0,OBIS_DIGIT_TYPE1,     //meter ac
             -tive constant  //
 123              0x28,  0xC712,      ADR_METER_PARAM1_SETL_DDHH,             (MEM_E2P1<<8)+2,                CHAR_SETTL,OBIS_DIGIT_TYPE4,    //meter act
             -ive constant  //
 124          
 125          } ;
 126          
 127          /*****************************************************************************
 128          ** Function name    :api_init_md_data_ram
 129          **
 130          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÏîÄ¿       
 131          **
 132          ** Parameters         :NONE          
 133          **
 134          ** Returned value   :NONE
 135          **
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 4   

 136          **----------------------------------------------------------------------------
 137          ** V01.01  MJ  2016-04-23
 138          ******************************************************************************/
 139          void api_init_display(void)
 140          {
 141   1          mem_read(&gs_dis_param.auto_sec, ADR_BLOCK21_DIS_PARAM_E2P, LEN_BLOCK21_DIS_PARAM_E2P, MEM_E2P1);    // 
             -    
 142   1          if((gs_dis_param.auto_sec<3)||(gs_dis_param.auto_sec>60))    gs_dis_param.auto_sec = 5;
 143   1          if((gs_dis_param.key_sec<5)||(gs_dis_param.key_sec>60))    gs_dis_param.key_sec = 30;
 144   1          gs_dis_ctl_var.mode = DIS_MODE_RESET;
 145   1          gs_dis_ctl_var.item = DIS_RESET;
 146   1          gs_dis_ctl_var.ptr[0] =1;  //´í¹ýÌõÊýÊý×é //
 147   1          gs_dis_ctl_var.keep_sec[0] = 0;
 148   1          gs_dis_ctl_var.keep_sec[1] = 0;
 149   1          gs_dis_ctl_var.keep_sec[2] = gs_dis_param.bg_sec;             //  ±³¹âÉÏµçµãÁÁ//
 150   1          gs_dis_ctl_var.keep_sec[3] = RESEAT_DIS_KEEP_3S; //  ÉÏµçÈ«ÆÁÏÔÊ¾Ê±¼ä//
 151   1      }
 152          
 153          /*****************************************************************************
 154          ** Function name    :api_init_md_data_ram
 155          **
 156          ** Description         :³õÊ¼»¯µ±Ç°ÐèÁ¿¼ÆËãRAMÇøÊý¾Ý£¬³ÌÐò¸´Î»³õÊ¼»¯µ÷ÓÃ        
 157          **
 158          ** Parameters         :NONE          
 159          **
 160          ** Returned value   :NONE
 161          **
 162          **----------------------------------------------------------------------------
 163          ** V01.01  MJ  2016-04-23
 164          ******************************************************************************/
 165          void api_handl_dis_key_10ms(void)
 166          {
 167   1          if((gs_sys_run.back_fg&BIT2_BACK_DIS_KEY)==0)
 168   1          {
 169   2              return;
 170   2          }
 171   1               
 172   1          if((Judge_DIS_key()==TRUE))
 173   1          {
 174   2               gs_dis_ctl_var.cnt_10ms_dis_key_delay++;
 175   2          }
 176   1          else
 177   1          {
 178   2             gs_dis_ctl_var.cnt_10ms_dis_key_delay = 0;
 179   2             gs_sys_run.back_fg &= ~BIT2_BACK_DIS_KEY;
 180   2             return;
 181   2          }
 182   1      
 183   1         if(gs_dis_ctl_var.cnt_10ms_dis_key_delay<10)    // ³ÖÐøÊ±¼ä´óÓÚ100ms ÏÔÊ¾°´¼üÓÐÐ§ //
 184   1         {
 185   2               return;
 186   2         }
 187   1      
 188   1          gs_dis_ctl_var.cnt_10ms_dis_key_delay = 0;
 189   1          gs_sys_run.back_fg &= ~BIT2_BACK_DIS_KEY;
 190   1              
 191   1          gs_dis_ctl_var.keep_sec[1] = gs_dis_param.key_sec; // °´¼ü³ÖÐøÊ±¼ä//
 192   1          gs_dis_ctl_var.keep_sec[2] = gs_dis_param.bg_sec; // ¿ª±³¹â//
 193   1      
 194   1          if((gs_dis_ctl_var.mode == DIS_MODE_NOMAL)||(gs_dis_ctl_var.mode == DIS_MODE_RESET))
 195   1          {
 196   2              gs_dis_ctl_var.mode = DIS_MODE_MAN;
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 5   

 197   2              mem_read(&gs_dis_param.key_item[0], ADR_DIS_PARAM_KEY_TAB, 11, MEM_E2P1);        // 
 198   2              gs_dis_ctl_var.ptr[1] =0;
 199   2             gs_dis_ctl_var.item = gs_dis_param.key_item[gs_dis_ctl_var.ptr[1]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1Î»
             -ÖÃ¿ªÊ¼ÎªÏîÄ¿ //
 200   2                      
 201   2          }
 202   1          else
 203   1          {
 204   2              gs_dis_ctl_var.item = api_get_next_dis_item();
 205   2          }
 206   1      
 207   1          api_updated_LCDDisplayPixel_per_second();
 208   1          
 209   1      }
 210          
 211          /*****************************************************************************
 212          ** Function name    :api_init_md_data_ram
 213          **
 214          ** Description         :³õÊ¼»¯µ±Ç°ÐèÁ¿¼ÆËãRAMÇøÊý¾Ý£¬³ÌÐò¸´Î»³õÊ¼»¯µ÷ÓÃ        
 215          **
 216          ** Parameters         :NONE          
 217          **
 218          ** Returned value   :NONE
 219          **
 220          **----------------------------------------------------------------------------
 221          ** V01.01  MJ  2016-04-23
 222          ******************************************************************************/
 223          void api_handl_dis_sleep(void)
 224          {
 225   1          gs_dis_ctl_var.mode = DIS_MODE_OFF;
 226   1          LCD_OFF();
 227   1      }
 228          
 229          /*****************************************************************************
 230          ** Function name    :api_init_md_data_ram
 231          **
 232          ** Description         :³õÊ¼»¯µ±Ç°ÐèÁ¿¼ÆËãRAMÇøÊý¾Ý£¬³ÌÐò¸´Î»³õÊ¼»¯µ÷ÓÃ        
 233          **
 234          ** Parameters         :NONE          
 235          **
 236          ** Returned value   :NONE
 237          **
 238          **----------------------------------------------------------------------------
 239          ** V01.01  MJ  2016-04-23
 240          ******************************************************************************/
 241          void api_handl_dis_sleep_key(void)
 242          {
 243   1          gs_dis_ctl_var.keep_sec[1] = gs_dis_param.key_sec; // °´¼ü³ÖÐøÊ±¼ä//
 244   1          if(gs_dis_ctl_var.mode != DIS_MODE_SLEEP)
 245   1         {
 246   2             mem_read(&gs_dis_param.auto_sec, ADR_BLOCK21_DIS_PARAM_E2P, LEN_BLOCK21_DIS_PARAM_E2P, MEM_E2P1);         
             -// 
 247   2              if((gs_dis_param.auto_sec<3)||(gs_dis_param.auto_sec>60))    gs_dis_param.auto_sec = 5;
 248   2              if((gs_dis_param.key_sec<5)||(gs_dis_param.key_sec>60))    gs_dis_param.key_sec = 30;
 249   2             gs_dis_ctl_var.ptr[2] =0;
 250   2             gs_dis_ctl_var.item = gs_dis_param.pwn_item[gs_dis_ctl_var.ptr[2]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1Î»
             -ÖÃ¿ªÊ¼ÎªÏîÄ¿ //       
 251   2             gs_dis_ctl_var.mode = DIS_MODE_SLEEP;
 252   2         }
 253   1         else
 254   1        {
 255   2             gs_dis_ctl_var.item = api_get_next_dis_item();    
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 6   

 256   2        }
 257   1      
 258   1        api_updated_LCDDisplayPixel_per_second();
 259   1      }
 260          
 261          
 262          
 263          /*****************************************************************************
 264          ** Function name    :api_updata_LCDDisplay_per_second
 265          **
 266          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÄÚÈÝ      
 267          **
 268          ** Parameters         :NONE          
 269          **
 270          ** Returned value   :NONE
 271          **
 272          **----------------------------------------------------------------------------
 273          ** V01.01  MJ  2016-04-23
 274          ******************************************************************************/
 275          void api_updated_LCDDisplayPixel_per_second(void)
 276          {
 277   1      
 278   1          Lib_Set_String(&gs_dis_pixel_var.dis_buff[0],0,DS_UNIT);
 279   1          // Ôö¼ÓÓ²¼þÐ£±íÏÔÊ¾¹¦ÄÜ //
 280   1          if((gs_dis_ctl_var.item>=DIS_ADJ_CH1_0) &&(gs_dis_ctl_var.item<=DIS_DATA_CLR))
 281   1          {
 282   2              api_LCDDisplay_adj_item(gs_dis_ctl_var.item);
 283   2              Link_Get_Dis_RealChar_buff();
 284   2              Link_Get_Dis_Drv_buff();                
 285   2              Write_LCD(&gs_dis_pixel_var.dis_buff[0]);         //½«Êý¾ÝÐ´ÈëÒº¾§Çý¶¯//
 286   2              return;
 287   2          }
 288   1      
 289   1          if(gs_dis_ctl_var.item>DIS_MAX_ITEM)
 290   1          {
 291   2              gs_dis_ctl_var.item = DIS_DEFAULT_ITEM;    // ÏµÍ³ÏÔÊ¾ÏîÄ¿Òì³£ºóµÄÄ¬ÈÏÎªÏÔÊ¾ÏµÍ³´íÎóÆÁ  //
 292   2          }
 293   1      
 294   1          if(gs_dis_ctl_var.item == DIS_RESET)
 295   1          {
 296   2              Lib_Set_String(&gs_dis_pixel_var.dis_buff[0],0xff,DS_UNIT);
 297   2          }
 298   1          else
 299   1          {
 300   2              Link_Get_DisTab_Var(gs_dis_ctl_var.item) ;   // ÏÔÊ¾  err               // »ñÈ¡ÏÔÊ¾ÏîÄ¿ÐÅÏ¢  //
 301   2              Link_Get_Dis_OBIS_Num_buff();   
 302   2              Link_Get_Dis_Data_Num_buff();
 303   2              Link_Get_Dis_Char_buff();            
 304   2              if(gs_sys_globaL_var.work_mode != SLEEP_MODE)   Link_Get_Dis_RealChar_buff();
 305   2              Link_Get_Dis_Drv_buff();                 
 306   2          }
 307   1      
 308   1          Write_LCD(&gs_dis_pixel_var.dis_buff[0]);         //½«Êý¾ÝÐ´ÈëÒº¾§Çý¶¯
 309   1      }
 310          
 311          /*****************************************************************************
 312          ** Function name    :api_updata_LCDDisplay_per_second
 313          **
 314          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÄÚÈÝ      
 315          **
 316          ** Parameters         :NONE          
 317          **
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 7   

 318          ** Returned value   :NONE
 319          **
 320          **----------------------------------------------------------------------------
 321          ** V01.01  MJ  2016-04-23
 322          ******************************************************************************/
 323          void api_updated_BG_per_second(void)
 324          {
 325   1          if(gs_dis_param.bg_sec>60)     //±³¹âµãÁÁÅäÖÃÊ±¼ä´óÓÚ60ÃëÔòÄ¬ÈÏ±³¹âÉÏµç²»Ï¨Ãð  //
 326   1          {
 327   2              LED_BG_ON();   
 328   2              return;
 329   2          }
 330   1          
 331   1          if(gs_dis_ctl_var.keep_sec[2]>0)
 332   1          {
 333   2              gs_dis_ctl_var.keep_sec[2]--;
 334   2              LED_BG_ON();  
 335   2          }
 336   1          else
 337   1          {
 338   2               LED_BG_OFF();    
 339   2          }
 340   1      
 341   1              if(gs_measure_status_judge_var.u8_status&REV_ACPOWER_L)
 342   1                      PIN_Reverse_HIGH()
 343   1              else
 344   1                      PIN_Reverse_LOW()
 345   1      }
 346          
 347          
 348          
 349          /*****************************************************************************
 350          ** Function name    :api_init_md_data_ram
 351          **
 352          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÏîÄ¿       
 353          **
 354          ** Parameters         :NONE          
 355          **
 356          ** Returned value   :NONE
 357          **
 358          **----------------------------------------------------------------------------
 359          ** V01.01  MJ  2016-04-23
 360          ******************************************************************************/
 361          void api_updated_LCDDisplayItem_per_second(void)
 362          {
 363   1      
 364   1          switch (gs_dis_ctl_var.mode )
 365   1          {
 366   2              case DIS_MODE_RESET:                     
 367   2                  gs_dis_ctl_var.keep_sec[3] --;
 368   2                  if(gs_dis_ctl_var.keep_sec[3]==0)  
 369   2                  {
 370   3                      gs_dis_ctl_var.mode = DIS_MODE_NOMAL;
 371   3                      gs_dis_ctl_var.keep_sec[0] = gs_dis_param.auto_sec;
 372   3                      gs_dis_ctl_var.ptr[0] = 0;
 373   3                      gs_dis_ctl_var.item = gs_dis_param.auto_item[gs_dis_ctl_var.ptr[0]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ
             -¿¸öÊý£¬1Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ //                
 374   3                  }
 375   2              break;
 376   2      
 377   2              case DIS_MODE_MAN:                       
 378   2                  gs_dis_ctl_var.keep_sec[1] --;
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 8   

 379   2                  if(gs_dis_ctl_var.keep_sec[1]==0)  
 380   2                  {
 381   3                      gs_dis_ctl_var.mode = DIS_MODE_NOMAL;
 382   3                      gs_dis_ctl_var.keep_sec[0] = gs_dis_param.auto_sec;
 383   3                      gs_dis_ctl_var.ptr[0] = 0;
 384   3                      gs_dis_ctl_var.item = gs_dis_param.auto_item[gs_dis_ctl_var.ptr[0]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ
             -¿¸öÊý£¬1Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ //  
 385   3                  }
 386   2              break;
 387   2      
 388   2              case DIS_MODE_NOMAL:                     
 389   2                  gs_dis_ctl_var.keep_sec[0] --;
 390   2                  if( gs_dis_ctl_var.keep_sec[0] == 0)
 391   2                  {
 392   3                      gs_dis_ctl_var.keep_sec[0] = gs_dis_param.auto_sec; //ÂÖÏÔ³ÖÐøÊ±¼ä//
 393   3                      gs_dis_ctl_var.item = api_get_next_dis_item();
 394   3                  }
 395   2              break;
 396   2      
 397   2              default:
 398   2                  gs_dis_ctl_var.mode = DIS_MODE_NOMAL;
 399   2              break;
 400   2      
 401   2          }   
 402   1      }
 403                     
 404          /*****************************************************************************
 405          ** Function name    :api_get_next_dis_item
 406          **
 407          ** Description         :·µ»ØÏÂÒ»¸öÏÔÊ¾ÏîÄ¿     
 408          **
 409          ** Parameters         :NONE          
 410          **
 411          ** Returned value   :NONE
 412          **
 413          **----------------------------------------------------------------------------
 414          ** V01.01  MJ  2016-04-23
 415          ******************************************************************************/
 416          INT8U api_get_next_dis_item(void)
 417          {
 418   1       INT8U vaild_len;
 419   1       INT8U item;
 420   1      
 421   1          item = DIS_DEFAULT_ITEM;
 422   1          if((gs_dis_ctl_var.mode  == DIS_MODE_NOMAL))
 423   1          {
 424   2              gs_dis_ctl_var.ptr[0]++;
 425   2              if((gs_dis_ctl_var.ptr[0]>=(gs_dis_param.auto_item[0]))||(gs_dis_ctl_var.ptr[0]>10))   //ÏîÄ¿Îª0~9
             -,¹²10Ïî //
 426   2              {
 427   3                  gs_dis_ctl_var.ptr[0]=0;
 428   3              }
 429   2      
 430   2              item = gs_dis_param.auto_item[gs_dis_ctl_var.ptr[0]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ 
             -//
 431   2              if(item>DIS_MAX_ITEM)   
 432   2              {
 433   3                  item =     DIS_DEFAULT_ITEM;
 434   3              }
 435   2          }
 436   1      
 437   1          if((gs_dis_ctl_var.mode ==DIS_MODE_MAN))
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 9   

 438   1          {
 439   2              gs_dis_ctl_var.ptr[1]++;
 440   2              if((gs_dis_ctl_var.ptr[1]>=(gs_dis_param.key_item[0]))||(gs_dis_ctl_var.ptr[1]>10))  //ÏîÄ¿Îª0~9,¹
             -²10Ïî //
 441   2              {
 442   3                  gs_dis_ctl_var.ptr[1]=0;
 443   3              }
 444   2      
 445   2              item = gs_dis_param.key_item[gs_dis_ctl_var.ptr[1]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ /
             -/
 446   2              if(item>DIS_MAX_ITEM)   
 447   2              {
 448   3                  item =     DIS_DEFAULT_ITEM;
 449   3              }
 450   2          }
 451   1      
 452   1          if((gs_dis_ctl_var.mode ==DIS_MODE_SLEEP))
 453   1          {
 454   2              gs_dis_ctl_var.ptr[2]++;
 455   2              if((gs_dis_ctl_var.ptr[2]>=(gs_dis_param.pwn_item[0]))||(gs_dis_ctl_var.ptr[2]>9))  //ÏîÄ¿Îª0~8,¹²
             -9Ïî //
 456   2              {
 457   3                  gs_dis_ctl_var.ptr[2]=0;
 458   3              }
 459   2      
 460   2              item = gs_dis_param.pwn_item[gs_dis_ctl_var.ptr[2]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ /
             -/
 461   2              if(item>DIS_MAX_ITEM)   
 462   2              {
 463   3                  item =     DIS_DEFAULT_ITEM;
 464   3              }
 465   2          }
 466   1          
 467   1          return (item);
 468   1      }
 469          
 470          //*****************************************************************
 471          //  Function:       INT8U Link_Get_DisIndex(u8_dis_itm)        
 472          //  Description:    »ñÈ¡ÏÔÊ¾ÏîÄ¿ÐÅÏ¢                                        
 473          //  Input:                                                                            
 474          //  Output:         no                              
 475          //  Return:         no                              
 476          //  Others:         
 477          //***************************************************************/
 478          INT8U Link_Get_DisTab_Var(INT8U u8_dis_itm)
 479          {
 480   1       INT8U i;
 481   1       INT8U u8_result=FALSE;
 482   1      
 483   1              if(u8_dis_itm>DIS_MAX_ITEM)
 484   1              {
 485   2                      u8_dis_itm = DIS_DEFAULT_ITEM;    // ÏµÍ³ÏÔÊ¾ÏîÄ¿Òì³£ºóµÄÄ¬ÈÏÎªÏÔÊ¾ÏµÍ³´íÎóÆÁ  //
 486   2              }
 487   1      
 488   1              for( i = 0 ; i <=DIS_MAX_ITEM ; i++ )
 489   1              {
 490   2                      if( u8_dis_itm== LcdDisTab[i].DisID)
 491   2                      {
 492   3                              gs_LCDDISTAB_var.DisID = u8_dis_itm;
 493   3                              gs_LCDDISTAB_var.ObisNum= LcdDisTab[i].ObisNum;
 494   3                              gs_LCDDISTAB_var.Addr =LcdDisTab[i].Addr;
 495   3                              gs_LCDDISTAB_var.DisInfo = LcdDisTab[i].DisInfo;
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 10  

 496   3                              gs_LCDDISTAB_var.chartype = LcdDisTab[i].chartype;
 497   3                              gs_LCDDISTAB_var.obis_digit= LcdDisTab[i].obis_digit;
 498   3                              u8_result = TRUE;
 499   3                              return (u8_result);
 500   3                      }
 501   2              }
 502   1      
 503   1              if(u8_result == FALSE )
 504   1              {
 505   2                      gs_LCDDISTAB_var.DisID = DIS_DEFAULT_ITEM;  // Ä¬ÈÏÏÔÊ¾µ±Ç°ÓÐ¹¦×Ü 
 506   2                      gs_LCDDISTAB_var.ObisNum = LcdDisTab[0x01].ObisNum;
 507   2                      gs_LCDDISTAB_var.Addr =LcdDisTab[0x01].Addr;
 508   2                      gs_LCDDISTAB_var.DisInfo = LcdDisTab[0x01].DisInfo;
 509   2                      gs_LCDDISTAB_var.chartype = LcdDisTab[0x01].chartype;           
 510   2              }
 511   1              return (u8_result);
 512   1                              
 513   1      }
 514          
 515          
 516          //*****************************************************************
 517          //  Function:      void Link_Get_Dis_OBIS_Num_buff(void)      
 518          //  Description:    »ñÈ¡OBISÇøµÄÏÔÊ¾ÄÚÈÝ£¬ 4¸ö8×ÖÇø                                       
 519          //  Input:                                                                            
 520          //  Output:         no                              
 521          //  Return:         no                              
 522          //  Others:         dis_obis_buff[0] ¶ÔÓ¦OBISÇøÏÔÊ¾µÄ×î×ó±ß1Î»(¸ßÎ»)
 523          //***************************************************************/
 524          void Link_Get_Dis_OBIS_Num_buff(void)
 525          { 
 526   1               Lib_Set_String(&gs_dis_pixel_var.dis_obis_buff[0],0,4);
 527   1              gs_dis_pixel_var.dis_obis_buff[0]  =NumSegOBIS[ (gs_LCDDISTAB_var.ObisNum & 0xF000) >>12];
 528   1              gs_dis_pixel_var.dis_obis_buff[1]  = NumSegOBIS[ (gs_LCDDISTAB_var.ObisNum & 0x0F00) >>8];
 529   1                gs_dis_pixel_var.dis_obis_buff[2]  = NumSegOBIS[ (gs_LCDDISTAB_var.ObisNum & 0x00F0) >>4];
 530   1                if((gs_LCDDISTAB_var.ObisNum&0x000F) == 0x000F)    gs_dis_pixel_var.dis_obis_buff[3] =0;
 531   1                else   gs_dis_pixel_var.dis_obis_buff[3]  = NumSegOBIS1[(gs_LCDDISTAB_var.ObisNum & 0x000F)];
 532   1      }               
 533                          
 534          
 535          
 536          //*****************************************************************
 537          //  Function:      void Link_Get_Dis_OBIS_Num_buff(void)      
 538          //  Description:    »ñÈ¡DATAÇøµÄÏÔÊ¾ÄÚÈÝ£¬ 8¸ö8×ÖÇø                                       
 539          //  Input:                                                                            
 540          //  Output:         no                              
 541          //  Return:         no                              
 542          //  Others:         dis_data_buff[0] ¶ÔÓ¦NUMÇøÏÔÊ¾µÄ×î×ó±ß1Î»(¸ßÎ»)
 543          //***************************************************************/
 544          void Link_Get_Dis_Data_Num_buff(void)
 545          {
 546   1       ST_U32_U08   buffer,u32_tmp;
 547   1       INT8U  temp[6],i;
 548   1       INT8U buffertemp1[16];
 549   1       INT8U u8_len,u8_mem_type;
 550   1       INT8U u8_tmp;
 551   1      
 552   1        INT8U meterid_asclen;
 553   1        INT8U meterid_len;
 554   1                      
 555   1              u8_len = (INT8U)gs_LCDDISTAB_var.DisInfo;
 556   1              if(u8_len>6) u8_len= 6;
 557   1      
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 11  

 558   1              u8_mem_type =  (INT8U)(gs_LCDDISTAB_var.DisInfo>>8);
 559   1      
 560   1              // Êý¾Ý»ñÈ¡´¦Àí  //
 561   1              switch (gs_LCDDISTAB_var.chartype)
 562   1              {
 563   2                      case CHAR_AEC:                   
 564   2                           if((gs_LCDDISTAB_var.ObisNum&0x000F )!= 0x000F)      //ÀúÊ·Êý¾Ý
 565   2                          {
 566   3                            mem_read(&temp[0],  api_get_bill_record_addr(gs_LCDDISTAB_var.Addr),LEN_EC_UNIT, u8_
             -mem_type );        //»ñÈ¡ÀúÊ·Êý¾Ý //
 567   3                            }
 568   2                              else  // µ±Ç°Êý¾Ý
 569   2                            { 
 570   3                               mem_read(&temp[0],gs_LCDDISTAB_var.Addr, LEN_EC_UNIT, u8_mem_type);            //»ñÈ¡µ±Ç°Êý¾Ý //
 571   3                            }
 572   2                            api_get_energy_LCD(&temp[0], gs_dis_param.ec_form,&buffer.B08[0]);
 573   2                              break;
 574   2                      case CHAR_MD:
 575   2                       if((gs_LCDDISTAB_var.ObisNum&0x000F) != 0x000F)      //ÀúÊ·Êý¾Ý
 576   2                         {
 577   3                            mem_read(&u32_tmp.B08[0],  api_get_bill_record_addr(gs_LCDDISTAB_var.Addr),4, u8_mem
             -_type );        //»ñÈ¡ÀúÊ·Êý¾Ý //
 578   3                            }
 579   2                              else  // µ±Ç°Êý¾Ý
 580   2                              {       
 581   3                               mem_read(&u32_tmp.B08[0],gs_LCDDISTAB_var.Addr, 4, u8_mem_type);               //»ñÈ¡µ±Ç°Êý¾Ý //
 582   3                             }
 583   2      
 584   2                              Lib_long_bcd4(&buffer.B08[0],u32_tmp.u32);          //  16½øÖÆ×ª10½øÖÆ// 
 585   2                          buffer.B08[0] = buffer.B08[1];
 586   2                          buffer.B08[1] = buffer.B08[2];
 587   2                          buffer.B08[2] = buffer.B08[3];
 588   2                              break;
 589   2      
 590   2                      case CHAR_V:
 591   2                      case CHAR_HZ:
 592   2                      case CHAR_PF:
 593   2                          mem_read(&u32_tmp.B08[2],gs_LCDDISTAB_var.Addr, 2, u8_mem_type);            //»ñÈ¡µ±Ç°Êý¾Ý //
 594   2                          Lib_word_bcd2(&buffer.B08[0],u32_tmp.W16[1]);          //  16½øÖÆ×ª10½øÖÆ// 
 595   2                              break;
 596   2      
 597   2                      case CHAR_A:
 598   2                      case CHAR_KW:
 599   2                          mem_read(&u32_tmp.B08[0],gs_LCDDISTAB_var.Addr, 4, u8_mem_type);            //»ñÈ¡µ±Ç°Êý¾Ý //
 600   2                          Lib_long_bcd4(&buffer.B08[0],u32_tmp.u32);          //  16½øÖÆ×ª10½øÖÆ// 
 601   2                          buffer.B08[0] = buffer.B08[1];
 602   2                          buffer.B08[1] = buffer.B08[2];
 603   2                          buffer.B08[2] = buffer.B08[3];
 604   2                              break;
 605   2                  
 606   2                    case CHAR_DATE:   // ÈÕÆÚÏÔÊ¾ DD.MM.YY//
 607   2                            buffer.B08[0] = gs_CurDateTime.Day;
 608   2                         buffer.B08[1] = gs_CurDateTime.Month;
 609   2                         buffer.B08[2] = gs_CurDateTime.Year;
 610   2                         break;
 611   2      
 612   2                      default:
 613   2                              mem_read(&buffer.B08[0],gs_LCDDISTAB_var.Addr, u8_len, u8_mem_type);            //»ñÈ¡µ±Ç°Êý¾Ý //
 614   2                              break;
 615   2              }
 616   1      
 617   1      
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 12  

 618   1              //±íºÅºó8Î»     E2Êý¾ÝÖ±½Ó¶Á³ö¸ñÊ½²»×ª»» //
 619   1              if(gs_LCDDISTAB_var.DisID == 0x26)     
 620   1              {
 621   2                      mem_read(&buffertemp1[0],gs_LCDDISTAB_var.Addr, 16, u8_mem_type);               //»ñÈ¡µ±Ç°Êý¾Ý //
 622   2                      meterid_asclen = Lib_get_data_0xFF_asclen(&buffertemp1[0], 16);
 623   2                      meterid_len = meterid_asclen/2;
 624   2                      if(meterid_len == 0) meterid_len = 1;
 625   2                      if(meterid_len>3) 
 626   2                      {
 627   3                              buffer.B08[3] = buffertemp1[meterid_len-1];
 628   3                              buffer.B08[2] = buffertemp1[meterid_len-2];
 629   3                              buffer.B08[1] = buffertemp1[meterid_len-3];
 630   3                              buffer.B08[0] = buffertemp1[meterid_len-4];
 631   3                              u8_len = 4;
 632   3                      }
 633   2                      else if (meterid_len>2) 
 634   2                      {
 635   3                              buffer.B08[2] = buffertemp1[meterid_len-1];
 636   3                              buffer.B08[1] = buffertemp1[meterid_len-2];
 637   3                              buffer.B08[0] = buffertemp1[meterid_len-3];
 638   3                              u8_len = 3;                     
 639   3                      }
 640   2                      else if (meterid_len>1) 
 641   2                      {
 642   3                              buffer.B08[1] = buffertemp1[meterid_len-1];
 643   3                              buffer.B08[0] = buffertemp1[meterid_len-2];
 644   3                              u8_len = 2;                                             
 645   3                      }
 646   2                      else  
 647   2                      {
 648   3                              buffer.B08[0] = buffertemp1[meterid_len-1];
 649   3                              u8_len = 1;                     
 650   3                      }       
 651   2                      
 652   2              }
 653   1              
 654   1              // ÏÔÊ¾BUFFÊý¾Ý»ñÈ¡ //
 655   1              Lib_Set_String(&gs_dis_pixel_var.dis_data_buff[0],0,8);
 656   1              switch(u8_len)
 657   1              {
 658   2                     case 4:
 659   2                      case 6:
 660   2      //                      gs_dis_pixel_var.dis_data_buff[0] = NumSeg[(buffer.B08[0]&0xF0)>>4]     ;  
 661   2      //                      gs_dis_pixel_var.dis_data_buff[1] = NumSeg[(buffer.B08[0]&0x0F)]        ; 
 662   2                              gs_dis_pixel_var.dis_data_buff[2] = NumSeg[(buffer.B08[1]&0xF0)>>4]     ;  
 663   2                              gs_dis_pixel_var.dis_data_buff[3] = NumSeg[(buffer.B08[1]&0x0F)]        ; 
 664   2                              gs_dis_pixel_var.dis_data_buff[4] = NumSeg[(buffer.B08[2]&0xF0)>>4]     ;  
 665   2                              gs_dis_pixel_var.dis_data_buff[5] = NumSeg[(buffer.B08[2]&0x0F)]        ; 
 666   2                              gs_dis_pixel_var.dis_data_buff[6] = NumSeg[(buffer.B08[3]&0xF0)>>4]     ;  
 667   2                              gs_dis_pixel_var.dis_data_buff[7] = NumSeg[(buffer.B08[3]&0x0F)]        ;                       
 668   2                              break;
 669   2      
 670   2                      case 3:
 671   2                              gs_dis_pixel_var.dis_data_buff[2] = NumSeg[(buffer.B08[0]&0xF0)>>4]     ;  
 672   2                              gs_dis_pixel_var.dis_data_buff[3] = NumSeg[(buffer.B08[0]&0x0F)]        ; 
 673   2                              gs_dis_pixel_var.dis_data_buff[4] = NumSeg[(buffer.B08[1]&0xF0)>>4]     ;  
 674   2                              gs_dis_pixel_var.dis_data_buff[5] = NumSeg[(buffer.B08[1]&0x0F)]        ; 
 675   2                              gs_dis_pixel_var.dis_data_buff[6] = NumSeg[(buffer.B08[2]&0xF0)>>4]     ;  
 676   2                              gs_dis_pixel_var.dis_data_buff[7] = NumSeg[(buffer.B08[2]&0x0F)]        ; 
 677   2                              break;
 678   2      
 679   2                      case 2:
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 13  

 680   2                              gs_dis_pixel_var.dis_data_buff[4] = NumSeg[(buffer.B08[0]&0xF0)>>4]     ;  
 681   2                              gs_dis_pixel_var.dis_data_buff[5] = NumSeg[(buffer.B08[0]&0x0F)]        ; 
 682   2                              gs_dis_pixel_var.dis_data_buff[6] = NumSeg[(buffer.B08[1]&0xF0)>>4]     ;  
 683   2                              gs_dis_pixel_var.dis_data_buff[7] = NumSeg[(buffer.B08[1]&0x0F)]        ; 
 684   2                              break;
 685   2                      case 1:
 686   2                              gs_dis_pixel_var.dis_data_buff[6] = NumSeg[(buffer.B08[0]&0xF0)>>4]     ;  
 687   2                              gs_dis_pixel_var.dis_data_buff[7] = NumSeg[(buffer.B08[0]&0x0F)]        ; 
 688   2                              break;
 689   2                      default:          // ³¤¶ÈÎª0 ÏÔÊ¾¿Õ
 690   2                                 break;
 691   2                       
 692   2                              
 693   2              }
 694   1              
 695   1                              
 696   1      }
 697          //*****************************************************************
 698          //  Function:       void Link_Get_Dis_Char_buff(void) 
 699          //  Description:    »ñÈ¡ÏÔÊ¾µÄÅäºÏ×Ö·ûÐÅÏ¢                                      
 700          //  Input:                                                                            
 701          //  Output:         no                              
 702          //  Return:         no                              
 703          //  Others:         
 704          //***************************************************************/
 705          void Link_Get_Dis_Char_buff(void)
 706          {
 707   1              Lib_Set_String(&gs_dis_pixel_var.dis_char_buff[0] ,0,3);
 708   1              
 709   1              //OBIS ÇøÐ¡Êýµã·ûºÅ»ñÈ¡  //
 710   1              switch(gs_LCDDISTAB_var.obis_digit)
 711   1              {
 712   2                      case OBIS_DIGIT_TYPE1:   // x.x.x
 713   2                              gs_dis_pixel_var.dis_char_buff[0] |=CHAR_OBIS_P1+CHAR_OBIS_P2;//+CHAR_OBIS_P3;  S7 S8
 714   2                              break;
 715   2                      case OBIS_DIGIT_TYPE2:  // x.x.x.x
 716   2                              gs_dis_pixel_var.dis_char_buff[0] |=CHAR_OBIS_P1+CHAR_OBIS_P2+CHAR_OBIS_P3;//+CHAR_OBIS_P4;  
 717   2                              break;
 718   2                      case OBIS_DIGIT_TYPE3:  // xx.x.x
 719   2                              gs_dis_pixel_var.dis_char_buff[0] |=CHAR_OBIS_P2+CHAR_OBIS_P3;//+CHAR_OBIS_P4;  
 720   2                              break;
 721   2                      case OBIS_DIGIT_TYPE4:  // x.xx.x
 722   2                              gs_dis_pixel_var.dis_char_buff[0] |=CHAR_OBIS_P1+CHAR_OBIS_P3;//+CHAR_OBIS_P4; 
 723   2                              break;
 724   2                      
 725   2                      case OBIS_DIGIT_TYPE0:
 726   2                      default:
 727   2                              break;
 728   2              }
 729   1              
 730   1              // DATA ÇøµÄÐ¡ÊýµãºÍµ¥Î»×Ö·û»ñÈ¡ //
 731   1              switch(gs_LCDDISTAB_var.chartype)
 732   1              {
 733   2                      case CHAR_AEC:   // µçÁ¿ÏÔÊ¾ xxxxxx.xx kwh//
 734   2                              if(gs_dis_param.ec_form !=0x80)// Á½Î»Ð¡Êý
 735   2                              {
 736   3                                  gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P11;  //
 737   3                                  gs_dis_pixel_var.dis_char_buff[1] |= CHAR_UNIT_K+CHAR_UNIT_V;  //kv
 738   3                                  gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_V2_1+CHAR_UNIT_V2_2+CHAR_UNIT_H;  //vh
 739   3                              }
 740   2                               else  // 8ÕûÊý
 741   2                             {
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 14  

 742   3                                   gs_dis_pixel_var.dis_char_buff[1] |= CHAR_UNIT_K+CHAR_UNIT_V;  //kv
 743   3                                   gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_V2_1+CHAR_UNIT_V2_2+CHAR_UNIT_H;  //vh
 744   3                              }
 745   2      
 746   2                           if((gs_LCDDISTAB_var.ObisNum&0x000F) == 0x000F)      //µ±Ç°ÔÂÊý¾Ý
 747   2                              {
 748   3                                if( (gs_LCDDISTAB_var.ObisNum&0x00F0)==0)           
 749   3                                      {
 750   4                                         gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TOTAL ;  // µ±Ç°×Ü
 751   4                                      }
 752   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0010)   
 753   3                                       {
 754   4                                          gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF+CHAR_TARIFF1;  // µ±Ç°×Ü
 755   4                                      }
 756   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0020)   
 757   3                                       {
 758   4                                                gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF ;
 759   4                                                gs_dis_pixel_var.dis_char_buff[1] |= CHAR_TARIFF2;
 760   4                                      }
 761   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0030)   
 762   3                                       {
 763   4                                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF;  
 764   4                                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF3;
 765   4                                      } // µ±Ç°×Ü
 766   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0040)   
 767   3                                       {
 768   4                                          gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF;
 769   4                                          gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF4;
 770   4                                       } // µ±Ç°×Ü
 771   3                               }
 772   2                               else   ////ÀúÊ·µçÁ¿Êý¾Ý
 773   2                                      {
 774   3                                        if( (gs_LCDDISTAB_var.ObisNum&0x00F0)==0)           
 775   3                                      {
 776   4                                         gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TOTAL ;  // µ±Ç°×Ü
 777   4                                      }
 778   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0010)   
 779   3                                       {
 780   4                                          gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF+CHAR_TARIFF1;  // µ±Ç°×Ü
 781   4                                      }
 782   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0020)   
 783   3                                       {
 784   4                                                gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF ;
 785   4                                                gs_dis_pixel_var.dis_char_buff[1] |= CHAR_TARIFF2;
 786   4                                      }
 787   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0030)   
 788   3                                       {
 789   4                                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF;  
 790   4                                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF3;
 791   4                                      } // µ±Ç°×Ü
 792   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0040)   
 793   3                                       {
 794   4                                          gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TARIFF;
 795   4                                          gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF4;
 796   4                                       } // µ±Ç°×Ü
 797   3                                      }
 798   2                       break;
 799   2                              
 800   2                      case CHAR_MD:    // ÐèÁ¿ÏÔÊ¾MD  xx.xxxx kw//
 801   2                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_DATA_P8;  
 802   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_CHR_MD+CHAR_UNIT_K+CHAR_UNIT_V;  //kv
 803   2                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_V2_1+CHAR_UNIT_V2_2;  //vh
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 15  

 804   2      
 805   2                               if((gs_LCDDISTAB_var.ObisNum&0x000F) == 0x000F)      //µ±Ç°ÔÂÊý¾Ý
 806   2                              {
 807   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0)            gs_dis_pixel_var.dis_char_buff[0] |= CHA
             -R_TOTAL ;  // µ±Ç°×Ü
 808   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0010)   gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TA
             -RIFF+CHAR_TARIFF1;  // µ±Ç°×Ü
 809   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0020)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF ; gs_dis_pixel_var.dis_char_buff[1] |= CHAR_TARIFF2;}
 810   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0030)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF;  gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF3;}// µ±Ç°×Ü
 811   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0040)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF;  gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF4;} // µ±Ç°×Ü
 812   3                               }
 813   2                               else  //ÀúÊ·ÐèÁ¿Êý¾Ý
 814   2                               {
 815   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0)            gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TOTAL ;
             -  // µ±Ç°×Ü
 816   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0010)   gs_dis_pixel_var.dis_char_buff[0] |= CHAR_TA
             -RIFF+CHAR_TARIFF1;  // µ±Ç°×Ü
 817   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0020)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF ; gs_dis_pixel_var.dis_char_buff[1] |= CHAR_TARIFF2;}
 818   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0030)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF;  gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF3;}// µ±Ç°×Ü
 819   3                                if((gs_LCDDISTAB_var.ObisNum&0x00F0)==0x0040)   {gs_dis_pixel_var.dis_char_buff[0] |= CHAR_T
             -ARIFF;  gs_dis_pixel_var.dis_char_buff[2] |= CHAR_TARIFF4;} // µ±Ç°×Ü
 820   3                              
 821   3                               }
 822   2      
 823   2                              break;
 824   2                      case CHAR_V:    // µçÑ¹ÏÔÊ¾ xxx.x V//
 825   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P12;  
 826   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_UNIT_V;  //V
 827   2                              break;
 828   2                      case CHAR_A:    // µçÁ÷ÏÔÊ¾ xxx.xxx A//
 829   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P9;  
 830   2                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_V2_2+CHAR_UNIT_A_1+CHAR_UNIT_A_3;  //A
 831   2                              break;
 832   2                      case CHAR_KW:    // ¹¦ÂÊÏÔÊ¾ xx.xxxx kw//
 833   2                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_DATA_P8;  
 834   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_UNIT_K+CHAR_UNIT_V;  //kv
 835   2                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_V2_1+CHAR_UNIT_V2_2;    //v 
 836   2                              break;
 837   2                      case CHAR_HZ:   // ÆµÂÊÏÔÊ¾ xx.xx HZ//
 838   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P11;  //
 839   2                              gs_dis_pixel_var.dis_char_buff[2] |= CHAR_UNIT_H+CHAR_UNIT_Z;  //V
 840   2                              break;
 841   2                              
 842   2                      case CHAR_TIME: // Ê±¼äÏÔÊ¾ HH.MM.SS//                  
 843   2                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_DATA_P7+CHAR_DATA_P8;  //
 844   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P10+CHAR_DATA_P11;  //
 845   2                              break;
 846   2      
 847   2                      case CHAR_DATE: // ÈÕÆÚÏÔÊ¾ DD.MM.YY//
 848   2                              gs_dis_pixel_var.dis_char_buff[0] |= CHAR_DATA_P8;  //
 849   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P11;  //
 850   2                              break;
 851   2      
 852   2                      case CHAR_PF:   // ¹¦ÂÊÒòÊýÏÔÊ¾x.xxx  //
 853   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P9;  //
 854   2                              break;
 855   2      
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 16  

 856   2                      case CHAR_SETTL:        // ½áËãÈÕÊ±²ÎÊýÏÔÊ¾ xx.xx //
 857   2                              gs_dis_pixel_var.dis_char_buff[1] |= CHAR_DATA_P11;  //
 858   2                              break;
 859   2                              
 860   2                      default:
 861   2                              break;
 862   2              }       
 863   1              
 864   1                              
 865   1      }
 866          
 867          //*****************************************************************
 868          //  Function:       INT8U Link_Get_DisIndex(u8_dis_itm)        
 869          //  Description:    »ñÈ¡ÏÔÊ¾ÏîÄ¿ÐÅÏ¢                                        
 870          //  Input:                                                                            
 871          //  Output:         no                              
 872          //  Return:         no                              
 873          //  Others:         
 874          //***************************************************************/
 875          void Link_Get_Dis_RealChar_buff(void)
 876          {
 877   1              if((gs_measure_status_judge_var.u8_status &VBAT_LOW) != 0)            gs_dis_pixel_var.dis_buff[19] |= BI
             -T1;        //µç³ØÇ·Ñ¹
 878   1            // if()          gs_dis_pixel_var.dis_buff[1] |= BIT0;    //·´Ïò
 879   1              if(TARIFF_MAX_NUM>1)
 880   1              {
 881   2                      switch(gs_current_triff_var.triff_No)
 882   2                      {
 883   3                              case 1:
 884   3                                      gs_dis_pixel_var.dis_buff[0] |= BIT1;
 885   3                                      break;
 886   3                              case 2:
 887   3                                      gs_dis_pixel_var.dis_buff[1] |= BIT2;
 888   3                                      break;
 889   3                              case 3:
 890   3                                      gs_dis_pixel_var.dis_buff[0] |= BIT0;
 891   3                                      break;
 892   3                              case 4:
 893   3                                      gs_dis_pixel_var.dis_buff[1] |= BIT1;
 894   3                                      break;
 895   3                              default:
 896   3                                      gs_current_triff_var.triff_No = 1;
 897   3                                     gs_dis_pixel_var.dis_buff[0] |= BIT1;
 898   3                                    break;
 899   3                      }
 900   2               }
 901   1      
 902   1      
 903   1      
 904   1      
 905   1      }
 906          
 907          
 908          //*****************************************************************
 909          //  Function:      void Link_Get_Dis_Drv_buff(void)   
 910          //  Description:    »ñÈ¡ÏÔÊ¾»º³åbuffµÄÊý¾Ý                                    
 911          //  Input:                                                                            
 912          //  Output:         no                              
 913          //  Return:         no                              
 914          //  Others:         
 915          //***************************************************************/
 916          void Link_Get_Dis_Drv_buff(void)
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 17  

 917          {
 918   1      
 919   1              
 920   1       //  dis_var.dis_obis_buff[0:3] µÄ×ª»»//
 921   1             // µÚÒ»¸ö8
 922   1              gs_dis_pixel_var.dis_buff[2] |= (gs_dis_pixel_var.dis_obis_buff[0] &(BIT0+BIT1));
 923   1             gs_dis_pixel_var.dis_buff[3] |= ((gs_dis_pixel_var.dis_obis_buff[0] &(BIT2+BIT3))>>2);
 924   1              gs_dis_pixel_var.dis_buff[4] |= ((gs_dis_pixel_var.dis_obis_buff[0] &(BIT4+BIT5))>>4);
 925   1              gs_dis_pixel_var.dis_buff[5] |= ((gs_dis_pixel_var.dis_obis_buff[0] &(BIT6))>>6);
 926   1              gs_dis_pixel_var.dis_buff[6] |= (gs_dis_pixel_var.dis_obis_buff[1] &(BIT0+BIT1));
 927   1             gs_dis_pixel_var.dis_buff[7] |= ((gs_dis_pixel_var.dis_obis_buff[1] &(BIT2+BIT3))>>2);
 928   1              gs_dis_pixel_var.dis_buff[8] |= ((gs_dis_pixel_var.dis_obis_buff[1] &(BIT4+BIT5))>>4);
 929   1              gs_dis_pixel_var.dis_buff[9] |= ((gs_dis_pixel_var.dis_obis_buff[1] &(BIT6))>>6);
 930   1              gs_dis_pixel_var.dis_buff[10] |= (gs_dis_pixel_var.dis_obis_buff[2] &(BIT0+BIT1));
 931   1             gs_dis_pixel_var.dis_buff[11] |= ((gs_dis_pixel_var.dis_obis_buff[2] &(BIT2+BIT3))>>2);
 932   1              gs_dis_pixel_var.dis_buff[12] |= ((gs_dis_pixel_var.dis_obis_buff[2] &(BIT4+BIT5))>>4);
 933   1              gs_dis_pixel_var.dis_buff[13] |= ((gs_dis_pixel_var.dis_obis_buff[2] &(BIT6))>>6);
 934   1         // µÚËÄ¸ö8
 935   1              gs_dis_pixel_var.dis_buff[14] |= (gs_dis_pixel_var.dis_obis_buff[3] &(BIT0+BIT1));
 936   1             gs_dis_pixel_var.dis_buff[15] |= ((gs_dis_pixel_var.dis_obis_buff[3] &(BIT2+BIT3))>>2);
 937   1              gs_dis_pixel_var.dis_buff[19] |= ((gs_dis_pixel_var.dis_obis_buff[3] &(BIT4))>>4);
 938   1              gs_dis_pixel_var.dis_buff[20] |= ((gs_dis_pixel_var.dis_obis_buff[3] &(BIT6+BIT7))>>6);
 939   1      
 940   1      
 941   1               
 942   1      
 943   1        
 944   1               //  dis_var.dis_data_buff[0:7] µÄ×ª»»//
 945   1              gs_dis_pixel_var.dis_buff[0] |= ((gs_dis_pixel_var.dis_data_buff[0] &0x0F)<<2);
 946   1              gs_dis_pixel_var.dis_buff[1] |= ((gs_dis_pixel_var.dis_data_buff[0] &0xF0)>>2);
 947   1              gs_dis_pixel_var.dis_buff[2] |= ((gs_dis_pixel_var.dis_data_buff[1] &0x0F)<<2);
 948   1              gs_dis_pixel_var.dis_buff[3] |= ((gs_dis_pixel_var.dis_data_buff[1] &0xF0)>>2);
 949   1              gs_dis_pixel_var.dis_buff[4] |= ((gs_dis_pixel_var.dis_data_buff[2] &0x0F)<<2);
 950   1              gs_dis_pixel_var.dis_buff[5] |= ((gs_dis_pixel_var.dis_data_buff[2] &0xF0)>>2);
 951   1              gs_dis_pixel_var.dis_buff[6] |= ((gs_dis_pixel_var.dis_data_buff[3] &0x0F)<<2);
 952   1              gs_dis_pixel_var.dis_buff[7] |= ((gs_dis_pixel_var.dis_data_buff[3] &0xF0)>>2);
 953   1              gs_dis_pixel_var.dis_buff[8] |= ((gs_dis_pixel_var.dis_data_buff[4] &0x0F)<<2);
 954   1              gs_dis_pixel_var.dis_buff[9] |= ((gs_dis_pixel_var.dis_data_buff[4] &0xF0)>>2);
 955   1              gs_dis_pixel_var.dis_buff[10] |= ((gs_dis_pixel_var.dis_data_buff[5] &0x0F)<<2);
 956   1              gs_dis_pixel_var.dis_buff[11] |= ((gs_dis_pixel_var.dis_data_buff[5] &0xF0)>>2);
 957   1              gs_dis_pixel_var.dis_buff[12] |= ((gs_dis_pixel_var.dis_data_buff[6] &0x0F)<<2);
 958   1              gs_dis_pixel_var.dis_buff[13] |= ((gs_dis_pixel_var.dis_data_buff[6] &0xF0)>>2);
 959   1              gs_dis_pixel_var.dis_buff[14] |= ((gs_dis_pixel_var.dis_data_buff[7] &0x0F)<<2);
 960   1              gs_dis_pixel_var.dis_buff[15] |= ((gs_dis_pixel_var.dis_data_buff[7] &0xF0)>>2);
 961   1      
 962   1      
 963   1      
 964   1               //  dis_var.dis_char_buff[0:2] µÄ×ª»»//
 965   1               if(gs_dis_pixel_var.dis_char_buff[0] &CHAR_OBIS_P1)    gs_dis_pixel_var.dis_buff[5] |= BIT1;
 966   1               if(gs_dis_pixel_var.dis_char_buff[0] &CHAR_OBIS_P2)    gs_dis_pixel_var.dis_buff[9] |= BIT1;
 967   1               if(gs_dis_pixel_var.dis_char_buff[0] &CHAR_OBIS_P3)    gs_dis_pixel_var.dis_buff[13] |= BIT1; 
 968   1             if(gs_dis_pixel_var.dis_char_buff[0] & CHAR_TOTAL)          gs_dis_pixel_var.dis_buff[18] |= BIT3;
 969   1             if(gs_dis_pixel_var.dis_char_buff[0] & CHAR_TARIFF)         gs_dis_pixel_var.dis_buff[18] |= BIT5;
 970   1             if(gs_dis_pixel_var.dis_char_buff[0] & CHAR_TARIFF1)        gs_dis_pixel_var.dis_buff[17] |= BIT5;
 971   1               if(gs_dis_pixel_var.dis_char_buff[0] &CHAR_DATA_P7)    gs_dis_pixel_var.dis_buff[5] |= BIT2;
 972   1               if(gs_dis_pixel_var.dis_char_buff[0] &CHAR_DATA_P8)    gs_dis_pixel_var.dis_buff[7] |= BIT2;
 973   1      
 974   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_DATA_P9)    gs_dis_pixel_var.dis_buff[9] |= BIT2;
 975   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_DATA_P10)           gs_dis_pixel_var.dis_buff[20] |= BIT5;
 976   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_DATA_P11)           gs_dis_pixel_var.dis_buff[11] |= BIT2;
 977   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_DATA_P12)           gs_dis_pixel_var.dis_buff[13] |= BIT2;
 978   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_CHR_MD)          gs_dis_pixel_var.dis_buff[18] |= BIT4;  
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 18  

 979   1               if(gs_dis_pixel_var.dis_char_buff[1] & CHAR_TARIFF2)        gs_dis_pixel_var.dis_buff[17] |= BIT4
             -;
 980   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_UNIT_K)           gs_dis_pixel_var.dis_buff[18] |= BIT2;
 981   1               if(gs_dis_pixel_var.dis_char_buff[1] &CHAR_UNIT_V)             gs_dis_pixel_var.dis_buff[18] |= BIT0;
 982   1      
 983   1               if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_V2_1)          gs_dis_pixel_var.dis_buff[18] |= BIT1;
 984   1               if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_V2_2)          gs_dis_pixel_var.dis_buff[16] |= BIT1;
 985   1               if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_A_1)           gs_dis_pixel_var.dis_buff[15] |= BIT2;
 986   1               if(gs_dis_pixel_var.dis_char_buff[2] & CHAR_TARIFF3)        gs_dis_pixel_var.dis_buff[17] |= BIT3
             -;
 987   1               if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_A_3)            gs_dis_pixel_var.dis_buff[16] |= BIT2;
 988   1               if(gs_dis_pixel_var.dis_char_buff[2] & CHAR_TARIFF4)        gs_dis_pixel_var.dis_buff[17] |= BIT2
             -;         
 989   1                if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_H)           gs_dis_pixel_var.dis_buff[16] |= BIT4;
 990   1              if(gs_dis_pixel_var.dis_char_buff[2] &CHAR_UNIT_Z)               gs_dis_pixel_var.dis_buff[16] |= BIT5;
 991   1      
 992   1      
 993   1      }
 994          
 995          
 996          
 997          
 998          
 999          /*****************************************************************************
1000          ** Function name    :api_clr_current_energy_data
1001          **
1002          ** Description         : ÐèÁ¿µçÁ¿Êý¾Ý×ª»»
1003          **
1004          ** Parameters         :  type Êý¾ÝÀàÐÍ     0Ä¬ÈÏÈ«ÕûÊý 
1005          **
1006          ** Returned value   :NONE
1007          **
1008          **----------------------------------------------------------------------------
1009          ** V01.01  MJ  2016-04-23
1010          ******************************************************************************/
1011          void api_get_energy_LCD(uint8*  temp, uint8 type, uint8*  result)
1012          {
1013   1       ST_U32_U08   u32_result, BCD_temp;
1014   1       INT8U  i;
1015   1       US_EC_DATA_UNIT ec_tmp;
1016   1         
1017   1           if(type!=0x80)     type= 0x62;
1018   1          //µçÁ¿¸ñÊ½Êý¾Ý¸³Öµ //
1019   1          Lib_Copy_Str_TwoArry(&ec_tmp.buf[0], temp, LEN_EC_UNIT);
1020   1          u32_result.u32 =0;
1021   1          if(type==0x80)
1022   1          {
1023   2              if(ec_tmp.val.integ_hex32>=100000000)   ec_tmp.val.integ_hex32 -=100000000;
1024   2              Lib_long_bcd4(&u32_result.B08[0],ec_tmp.val.integ_hex32);       
1025   2          }
1026   1          
1027   1          if(type==0x62)
1028   1          {
1029   2              // ÕûÊý²¿·Ö´¦Àí //
1030   2              if(ec_tmp.val.integ_hex32>=1000000)   ec_tmp.val.integ_hex32 -=1000000;
1031   2              Lib_long_bcd4(&BCD_temp.B08[0],ec_tmp.val.integ_hex32);
1032   2              u32_result.B08[0]= BCD_temp.B08[1];
1033   2              u32_result.B08[1]= BCD_temp.B08[2];
1034   2              u32_result.B08[2]= BCD_temp.B08[3];
1035   2      
1036   2               // Ð¡Êý²¿·Ö´¦Àí //
1037   2               ec_tmp.val.decim_hex16  /= METER_CONST_10WH;
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 19  

1038   2               u32_result.B08[3] = Lib_byte_bcd((INT8U)ec_tmp.val.decim_hex16);
1039   2      
1040   2          }
1041   1       
1042   1          //Êý¾ÝÊä³ö //
1043   1          Lib_Copy_Str_TwoArry(result, &u32_result.B08[0], 4);
1044   1      
1045   1      }
1046          
1047          
1048          
1049          /*****************************************************************************
1050          ** Function name    :api_init_md_data_ram
1051          **
1052          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÏîÄ¿       
1053          **
1054          ** Parameters         :NONE          
1055          **
1056          ** Returned value   :NONE
1057          **
1058          **----------------------------------------------------------------------------
1059          ** V01.01  MJ  2016-04-23
1060          ******************************************************************************/
1061          void api_chg_LCDDisplay_adj_item(uint8 u8_item)
1062          {
1063   1          if((u8_item>=DIS_ADJ_CH1_0) &&(u8_item<=DIS_DATA_CLR))
1064   1          {
1065   2              //¸ü¸ÄÐ£×¼ÏÔÊ¾ÏîÄ¿//
1066   2              gs_dis_ctl_var.mode = DIS_MODE_NOMAL;
1067   2              gs_dis_ctl_var.keep_sec[0] = 5;    //Ç¿ÖÆÏÔÊ¾5Ãë //
1068   2              gs_dis_ctl_var.ptr[0] = 0;
1069   2              gs_dis_ctl_var.item = u8_item;    
1070   2          }
1071   1          else
1072   1          {
1073   2              //Òì³£Çé¿öÏÂÏÔÊ¾×Ô¶¯Ñ­ÏÔÏîÄ¿ //
1074   2              gs_dis_ctl_var.mode = DIS_MODE_NOMAL;
1075   2              gs_dis_ctl_var.keep_sec[0] = gs_dis_param.auto_sec;
1076   2              gs_dis_ctl_var.ptr[0] = 0;
1077   2              gs_dis_ctl_var.item = gs_dis_param.auto_item[gs_dis_ctl_var.ptr[0]+1];  //  0Î»ÖÃÎªÏÔÊ¾ÏîÄ¿¸öÊý£¬1
             -Î»ÖÃ¿ªÊ¼ÎªÏîÄ¿ //  
1078   2          }
1079   1      
1080   1          api_updated_LCDDisplayPixel_per_second();
1081   1      }
1082          
1083          /*****************************************************************************
1084          ** Function name    :api_init_md_data_ram
1085          **
1086          ** Description         :Ã¿Ãë¸üÐÂÒº¾§ÏÔÊ¾ÏîÄ¿       
1087          **
1088          ** Parameters         :NONE          
1089          **
1090          ** Returned value   :NONE
1091          **
1092          **----------------------------------------------------------------------------
1093          ** V01.01  MJ  2016-04-23
1094          ******************************************************************************/
1095          void api_LCDDisplay_adj_item(uint8 u8_item)
1096          {
1097   1          if((u8_item<DIS_ADJ_CH1_0) &&(u8_item>DIS_DATA_CLR))
1098   1          {
C51 COMPILER V9.01   API_LCD_DISPLAY                                                       01/31/2019 11:37:33 PAGE 20  

1099   2              return;
1100   2          }
1101   1      
1102   1          Lib_Set_String(&gs_dis_pixel_var.dis_data_buff[0],0,DS_DATANum);    
1103   1          Lib_Set_String(&gs_dis_pixel_var.dis_obis_buff[0],0,DS_OBISNum);
1104   1          Lib_Set_String(&gs_dis_pixel_var.dis_char_buff[0] ,0,DS_CHARNum);
1105   1      
1106   1          // Êý¾Ý»ñÈ¡´¦Àí  //
1107   1          switch (u8_item)
1108   1          {
1109   2              case DIS_ADJ_CH1_0:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1110   2              case DIS_ADJ_CH1_1:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1111   2              case DIS_ADJ_CH1_2:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1112   2              case DIS_ADJ_CH1_3:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1113   2                  gs_dis_pixel_var.dis_data_buff[0] = NumSeg[0X0C]    ;      //LCD-D1  C  //
1114   2                  gs_dis_pixel_var.dis_data_buff[1] = 0XE6    ;                                //LCD-D2  H  //
1115   2                  gs_dis_pixel_var.dis_data_buff[2] = NumSeg[0X01]    ;     //LCD-D3  1  //
1116   2                  gs_dis_pixel_var.dis_data_buff[3] = 0X40    ;                                 //LCD-D4  -//
1117   2                  gs_dis_pixel_var.dis_data_buff[4] = NumSeg[(u8_item&0X0F)]  ;     //LCD-D5  0~3  //
1118   2              break;
1119   2      
1120   2              case DIS_ADJ_CH2_0:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1121   2              case DIS_ADJ_CH2_1:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1122   2              case DIS_ADJ_CH2_2:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1123   2              case DIS_ADJ_CH2_3:     //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1124   2                  gs_dis_pixel_var.dis_data_buff[0] = NumSeg[0X0C]    ;      //LCD-D1  C  //
1125   2                  gs_dis_pixel_var.dis_data_buff[1] = 0XE6    ;                                //LCD-D2  H  //
1126   2                  gs_dis_pixel_var.dis_data_buff[2] = NumSeg[0X02]    ;     //LCD-D3  2  //
1127   2                  gs_dis_pixel_var.dis_data_buff[3] = 0X40    ;                                 //LCD-D4  -//
1128   2                  gs_dis_pixel_var.dis_data_buff[4] = NumSeg[(u8_item&0X0F)-4]        ;     //LCD-D5  0~3  //
1129   2              break;
1130   2      
1131   2              case DIS_DATA_CLR:      //L »ØÂ·Ð£±í²ÎÊý³õÊ¼»¯ //
1132   2                  gs_dis_pixel_var.dis_data_buff[0] = NumSeg[0X0C]    ;      //LCD-D1  C  //
1133   2                  gs_dis_pixel_var.dis_data_buff[1] = 0X07    ;                                //LCD-D2  L  //
1134   2                  gs_dis_pixel_var.dis_data_buff[2] = 0x42    ;                               //LCD-D3  r  //
1135   2              break;
1136   2      
1137   2              default:        
1138   2                  sys_err();
1139   2              break;
1140   2          }
1141   1       
1142   1      }
1143          
1144          /***************************************************************
1145          *    END
1146          ****************************************************************/
1147          
1148          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4615    ----
   CONSTANT SIZE    =    455    ----
   XDATA SIZE       =     94      58
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
